
---
title: "Trait-based Comparative Transcriptomics Analysis"
author: "Joris van Steenbrugge"
date: "August 23, 2017"
output: html_document
---
```{r,results='hide'}
library(TcT)
```
#Loading and Preprocessing Data


All of the preprocessing is handled by the `Pre_process_input` function.
This function consequtively performs the following tasks:

1. Data Loading
2. Normalization
3. Filtering


### Data loading
The data set should contain the following Elements:

* A column named **Gene**
* Multiple expression data columns that have at least the word **Sample** in it
* A column named **Annotation**
* A column named **Bin**

Additional columns may be present but are not used in the analysis.
Loading of data is done by assigning a file.path to the function's `filepath`
variable.

### Normalization
The package supports different options for normalization. By default the `Pre_process_input` function
does not normalize the data. To indicate if normalization should be performed, the function parameter 
`normalize.var` may be used. The variable can either be left out, set to 'default', or to a custom user-defined function.
```{r}
file.path          <- "/home/joris/TcT/data/sample_data_newKO.csv"
annotation.db.path <- "/home/joris/TcT/data/updated_KO_modules.tsv"

RNAseq.data <- Pre_process_input(file.path,
                                 annotation.db.path,
                                 normalize.method    = FALSE,
                                 filter.method       = 'MAD',
                                 filter.low.coverage = T)

#Visualize 
#knitr::kable(RNAseq.data$table[1:10, ])

```

#### Additional Filter step
```{r}
single.copy.genes <- read.csv("D:/Users/JorisS/Downloads/PortableGit/TcT/data/SCG_KOterms.txt", stringsAsFactors = F)[,1]
single.copy.genes.n <- length(single.copy.genes)

matches.per.genome <- sapply(RNAseq.data_new$features$bins,
       function(bin){
         bin.annotations <- unique(RNAseq.data_new$table[which(RNAseq.data_new$table$Bin == bin), 'Annotation'])
         total.scg <- sum(single.copy.genes %in% bin.annotations)
         total.scg
         }
       )

#Filter out low quality bins
RNAseq.data$features$bins <- RNAseq.data$features$bins[-which(matches.per.genome != 11 )]

```


### Define the distance metrics to be used
In this vignette, the Pearson Correlation and the Normalized Rank Euclidean Distance are used.
The user is free to implement different metrics, as long as the function parameters
are identical to the ones in the example PC and NRED functions.
In these examples, rowA and rowB are rows from RNAseq.data$table.
```{r}
# Calculates the Pearson Correlation
PC <- function(rowA, rowB, RNAseq.features){
  return(cor(as.numeric(rowA[RNAseq.features$sample.columns]),
             as.numeric(rowB[RNAseq.features$sample.columns])
             )
         )
}

# Calculates the Normalized Rank Euclidean Distance
NRED <- function(rowA, rowB, RNAseq.features) {
  r.A <- as.numeric(rowA[ RNAseq.features$rank.columns ])
  r.B <- as.numeric(rowB[ RNAseq.features$rank.columns ])
  return(
    sum((r.A - r.B) * (r.A - r.B))
  )
}

# Combine multiple distance metrics to complement each other.
distance.metrics <- list("PC"   = PC,
                         "NRED" = NRED)
```

### Actual Analysis
```{r}
bkgd.individual         <- Individual_Annotation_Background(RNAseq.data = RNAseq.data, 
                                                            N           = 10000, 
                                                            metrics     = distance.metrics,
                                                            threads = 2)

bkgd.individual.Zscores <- Calc_Z_scores(bkgd.individual, distance.metrics)

bkgd.traits             <- Random_Trait_Background(RNAseq.data, bkgd.individual.Zscores,
                                                   N = 10000, Z = 1:30, distance.metrics,
                                                   threads = 2)
save.image('bkgdistributions.RData')
######
start <- Sys.time()
pairwise.distances      <- Calc_Pairwise_Annotation_Distance(RNAseq.data,distance.metrics =distance.metrics,
                                                             bkgd.individual.Zscores =  bkgd.individual.Zscores,
                                                             show.progress = T,
                                                             threads = 2)
end <- Sys.time()
save.image("pairwise.distances")
trait.attributes        <- Identify_Trait_Attributes(RNAseq.data, pairwise.distances,threads = 2)

trait.attributes.pruned <- Prune_Trait_Attributes(trait.attributes, bkgd.traits, 
                                                  RNAseq.data$features,
                                                  p.threshold = 0.05, 
                                                  completion.threshold = 0.75)
sbs.trait.attributes    <- Traitattributes_To_Sbsmatrix(trait.attributes.pruned, RNAseq.data$features$bins)

save.image('bgsAndPairwiseDistances.RData')

```

## Plotting
```{r}
Plot_Trait_Attribute_Expression('M00844.2', trait.attributes.pruned, RNAseq.data)
Plot_Background_Individual_Genes(bkgd.individual.Zscores)
Plot_Background_Modules(bkgd.modules)

Network_Trait_Genomes(c('M00178'), trait.attributes.pruned)
```

## Apriori

```{r}

rules <- Association_Rules(sbs.trait.attributes, N =30)

Network_Association_Rules(as(rules, 'data.frame'),annotation.db = RNAseq.data$features$annotation.db,
             N = 30)
```


## Experimental
```{r}
Go_Fish('K00927', RNAseq.data,
        type = 'peak')
```


